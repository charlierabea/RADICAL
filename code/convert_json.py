# this code convert the image descriptions excel to a json file(mimicit.json)
# the complete set should refer to open_json_patient.py
import pandas as pd 
import json
import os
from tqdm import tqdm

# Load the Excel file
excel_path = '/local2/chengyili/data/output/0824_2011-Glaucoma_anonymized.xlsx'
df = pd.read_excel(excel_path)

data = {}
instruction_text = ("You are an AI assistant specialized in radiology topics. "
                    "\n\n You are provided with brain CT slices from a single study. "
                    "The number of slices is usually around 30 when it's the coronal section, "
                    "or 60 when sagittal section is added. \n Please generate image caption based on image"
                    "You would have to look at the images to see if there's the following conditions: \n\n"
                    "brain atrophy/meningioma/fracture/soft tissue swelling/hydrocephalus/low density patches/enlargement of the ventricular system/enlargement of the sulci/calcified plaques/midline shift/intracranial hepatoma/epidural hepatoma/subdural hepatoma/lacunar infarction/cortical infarction/subcortical infarction/herniation\tarteriosclerotic/encephalopathy/encephalomalacia/wall calcification of cavernous ICA\n\n")

# Define the destination directory
destination_directory = '/home/chengyili/data/CT/mved/'

def reformat_image_id(image_id: str) -> str:
    """
    Reformat the image ID from the format "A_3_Study_1_80248_5.bmp" 
    to "DC_IMG_A_3_Study_1_80248_5".
    """
    ID = image_id.split('.')[0]
    parts = ID.split('_')
    new_format = f"eval_IMG_{parts[0]}_{parts[1]}_{parts[2]}_{parts[3]}_{parts[4]}_{parts[5]}"
    return new_format

# Map each study to its set of images
n=1
image_ids_map = {}
for image_file in tqdm(os.listdir(destination_directory), desc="Mapping images"):
    if image_file.endswith('.bmp'):
        # Extract the Patient and Study part of the filename (e.g., "A_3_Study_1" from "A_3_Study_1_80248_1.bmp")
        complete_set = {'A_7752', 'A_7753', 'A_7754', 'A_7755', 'A_7756', 'A_7757', 'A_7758', 'A_7759', 'A_7760', 'A_7761', 'A_7762', 'A_7763', 'A_7764', 'A_7765', 'A_7766', 'A_7767', 'A_7768', 'A_7769', 'A_7770', 'A_7771', 'A_7772', 'A_7773', 'A_7774', 'A_7775', 'A_7776', 'A_7777', 'A_7778', 'A_7779', 'A_7780', 'A_7781', 'A_7782', 'A_7783', 'A_7784', 'A_7785', 'A_7786', 'A_7787', 'A_7788', 'A_7789', 'A_7790', 'A_7791', 'A_7792', 'A_7793', 'A_7794', 'A_7795', 'A_7796', 'A_7797', 'A_7798', 'A_7799', 'A_7800', 'A_7801', 'A_7802', 'A_7803', 'A_7804', 'A_7805', 'A_7806', 'A_7807', 'A_7808', 'A_7809', 'A_7810', 'A_7811', 'A_7812', 'A_7813', 'A_7814', 'A_7815', 'A_7816', 'A_7817', 'A_7818', 'A_7819', 'A_7820', 'A_7821', 'A_7822', 'A_7823', 'A_7824', 'A_7825', 'A_7826', 'A_7827', 'A_7828', 'A_7829', 'A_7830', 'A_7831', 'A_7832', 'A_7833', 'A_7834', 'A_7835', 'A_7836', 'A_7837', 'A_7838', 'A_7839', 'A_7840', 'A_7841', 'A_7842', 'A_7843', 'A_7844', 'A_7845', 'A_7846', 'A_7847', 'A_7848', 'A_7849', 'A_7850', 'A_7851', 'A_7852', 'A_7853', 'A_7854', 'A_7855', 'A_7856', 'A_7857', 'A_7858', 'A_7859', 'A_7860', 'A_7861', 'A_7862', 'A_7863', 'A_7864', 'A_7865', 'A_7866', 'A_7867', 'A_7868', 'A_7869', 'A_7870', 'A_7871', 'A_7872', 'A_7873', 'A_7874', 'A_7875', 'A_7876', 'A_7877', 'A_7878', 'A_7879', 'A_7880', 'A_7881', 'A_7882', 'A_7883', 'A_7884', 'A_7885', 'A_7886', 'A_7887', 'A_7888', 'A_7889', 'A_7890', 'A_7891', 'A_7892', 'A_7893', 'A_7894', 'A_7895', 'A_7896', 'A_7897', 'A_7898', 'A_7899', 'A_7900', 'A_7901', 'A_7902', 'A_7903', 'A_7904', 'A_7905', 'A_7906', 'A_7907', 'A_7908', 'A_7909', 'A_7910', 'A_7911', 'A_7912', 'A_7913', 'A_7914', 'A_7915', 'A_7916', 'A_7917', 'A_7918', 'A_7919', 'A_7920', 'A_7921', 'A_7922', 'A_7923', 'A_7924', 'A_7925', 'A_7926', 'A_7927', 'A_7928', 'A_7929', 'A_7930', 'A_7931', 'A_7932', 'A_7933', 'A_7934', 'A_7935', 'A_7936', 'A_7937', 'A_7938', 'A_7939', 'A_7940', 'A_7941', 'A_7942', 'A_7943', 'A_7944', 'A_7945', 'A_7946', 'A_7947', 'A_7948', 'A_7949', 'A_7950', 'A_7951', 'A_7952', 'A_7953', 'A_7954', 'A_7955', 'A_7956', 'A_7957', 'A_7958', 'A_7959', 'A_7960', 'A_7961', 'A_7962', 'A_7963', 'A_7964', 'A_7965', 'A_7966', 'A_7967', 'A_7968', 'A_7969', 'A_7970', 'A_7971', 'A_7972', 'A_7973', 'A_7974', 'A_7975', 'A_7976', 'A_7977', 'A_7978', 'A_7979', 'A_7980', 'A_7981', 'A_7982', 'A_7983', 'A_7984', 'A_7985', 'A_7986', 'A_7987', 'A_7988', 'A_7989', 'A_7990', 'A_7991', 'A_7992', 'A_7993', 'A_7994', 'A_7995', 'A_7996', 'A_7997', 'A_7998', 'A_7999', 'A_8000', 'A_8001', 'A_8002', 'A_8003', 'A_8004', 'A_8005', 'A_8006', 'A_8007', 'A_8008', 'A_8009', 'A_8010', 'A_8011', 'A_8012', 'A_8013', 'A_8014', 'A_8015', 'A_8016', 'A_8017', 'A_8018', 'A_8019', 'A_8020', 'A_8021', 'A_8022', 'A_8023', 'A_8024', 'A_8025', 'A_8026', 'A_8027', 'A_8028', 'A_8029', 'A_8030', 'A_8031', 'A_8032', 'A_8033', 'A_8034', 'A_8035', 'A_8036', 'A_8037', 'A_8038', 'A_8039', 'A_8040', 'A_8041', 'A_8042', 'A_8043', 'A_8044', 'A_8045', 'A_8046', 'A_8047', 'A_8048', 'A_8049', 'A_8050', 'A_8051', 'A_8052', 'A_8053', 'A_8054', 'A_8055', 'A_8056', 'A_8057', 'A_8058', 'A_8059', 'A_8060', 'A_8061', 'A_8062', 'A_8063', 'A_8064', 'A_8065', 'A_8066', 'A_8067', 'A_8068', 'A_8069', 'A_8070', 'A_8071', 'A_8072', 'A_8073', 'A_8074', 'A_8075', 'A_8076', 'A_8077', 'A_8078', 'A_8079', 'A_8080', 'A_8081', 'A_8082', 'A_8083', 'A_8084', 'A_8085', 'A_8086', 'A_8087', 'A_8088', 'A_8089', 'A_8090', 'A_8091', 'A_8092', 'A_8093', 'A_8094', 'A_8095', 'A_8096', 'A_8097', 'A_8098', 'A_8099', 'A_8100', 'A_8101', 'A_8102', 'A_8103', 'A_8104', 'A_8105', 'A_8106', 'A_8107', 'A_8108', 'A_8109', 'A_8110', 'A_8111', 'A_8112', 'A_8113', 'A_8114', 'A_8115', 'A_8116', 'A_8117', 'A_8118', 'A_8119', 'A_8120', 'A_8121', 'A_8122', 'A_8123', 'A_8124', 'A_8125', 'A_8126', 'A_8127', 'A_8128', 'A_8129', 'A_8130', 'A_8131', 'A_8132', 'A_8133', 'A_8134', 'A_8135', 'A_8136', 'A_8137', 'A_8138', 'A_8139', 'A_8140', 'A_8141', 'A_8142', 'A_8143', 'A_8144', 'A_8145', 'A_8146', 'A_8147', 'A_8148', 'A_8149', 'A_8150', 'A_8151', 'A_8152', 'A_8153', 'A_8154', 'A_8155', 'A_8156', 'A_8157', 'A_8158', 'A_8159', 'A_8160', 'A_8161', 'A_8162', 'A_8163', 'A_8164', 'A_8165', 'A_8166', 'A_8167', 'A_8168', 'A_8169', 'A_8170', 'A_8171', 'A_8172', 'A_8173', 'A_8174', 'A_8175', 'A_8176', 'A_8177', 'A_8178', 'A_8179', 'A_8180', 'A_8181', 'A_8182', 'A_8183', 'A_8184', 'A_8185', 'A_8186', 'A_8187', 'A_8188', 'A_8189', 'A_8190', 'A_8191', 'A_8192', 'A_8193', 'A_8194', 'A_8195', 'A_8196', 'A_8197', 'A_8198', 'A_8199', 'A_8200', 'A_8201', 'A_8202', 'A_8203', 'A_8204', 'A_8205', 'A_8206', 'A_8207', 'A_8208', 'A_8209', 'A_8210', 'A_8211', 'A_8212', 'A_8213', 'A_8214', 'A_8215', 'A_8216', 'A_8217', 'A_8218', 'A_8219', 'A_8220', 'A_8221', 'A_8222', 'A_8223', 'A_8224', 'A_8225', 'A_8226', 'A_8227', 'A_8228', 'A_8229', 'A_8230', 'A_8231', 'A_8232', 'A_8233', 'A_8234', 'A_8235', 'A_8236', 'A_8237', 'A_8238', 'A_8239', 'A_8240', 'A_8241', 'A_8242', 'A_8243', 'A_8244', 'A_8245', 'A_8246', 'A_8247', 'A_8248', 'A_8249', 'A_8250', 'A_8251', 'A_8252', 'A_8253', 'A_8254', 'A_8255', 'A_8256', 'A_8257', 'A_8258', 'A_8259', 'A_8260', 'A_8261', 'A_8262', 'A_8263', 'A_8264', 'A_8265', 'A_8266', 'A_8267', 'A_8268', 'A_8269', 'A_8270', 'A_8271', 'A_8272', 'A_8273', 'A_8274', 'A_8275', 'A_8276', 'A_8277', 'A_8278', 'A_8279', 'A_8280', 'A_8281', 'A_8282', 'A_8283', 'A_8284', 'A_8285', 'A_8286', 'A_8287', 'A_8288', 'A_8289', 'A_8290', 'A_8291', 'A_8292', 'A_8293', 'A_8294', 'A_8295', 'A_8296', 'A_8297', 'A_8298', 'A_8299', 'A_8300', 'A_8301', 'A_8302', 'A_8303', 'A_8304', 'A_8305', 'A_8306', 'A_8307', 'A_8308', 'A_8309', 'A_8310', 'A_8311', 'A_8312', 'A_8313', 'A_8314', 'A_8315', 'A_8316', 'A_8317', 'A_8318', 'A_8319', 'A_8320', 'A_8321', 'A_8322', 'A_8323', 'A_8324', 'A_8325', 'A_8326', 'A_8327', 'A_8328', 'A_8329', 'A_8330', 'A_8331', 'A_8332', 'A_8333', 'A_8334', 'A_8335', 'A_8336', 'A_8337', 'A_8338', 'A_8339', 'A_8340', 'A_8341', 'A_8342', 'A_8343', 'A_8344', 'A_8345', 'A_8346', 'A_8347', 'A_8348', 'A_8349', 'A_8350', 'A_8351', 'A_8352', 'A_8353', 'A_8354', 'A_8355', 'A_8356', 'A_8357', 'A_8358', 'A_8359', 'A_8360', 'A_8361', 'A_8362', 'A_8363', 'A_8364', 'A_8365', 'A_8366', 'A_8367', 'A_8368', 'A_8369', 'A_8370', 'A_8371', 'A_8372', 'A_8373', 'A_8374', 'A_8375', 'A_8376', 'A_8377', 'A_8378', 'A_8379', 'A_8380', 'A_8381', 'A_8382', 'A_8383', 'A_8384', 'A_8385', 'A_8386', 'A_8387', 'A_8388', 'A_8389', 'A_8390', 'A_8391', 'A_8392', 'A_8393', 'A_8394', 'A_8395', 'A_8396', 'A_8397', 'A_8398', 'A_8399', 'A_8400', 'A_8401', 'A_8402', 'A_8403', 'A_8404', 'A_8405', 'A_8406', 'A_8407', 'A_8408', 'A_8409', 'A_8410', 'A_8411', 'A_8412', 'A_8413', 'A_8414', 'A_8415', 'A_8416', 'A_8417', 'A_8418', 'A_8419', 'A_8420', 'A_8421', 'A_8422', 'A_8423', 'A_8424', 'A_8425', 'A_8426', 'A_8427', 'A_8428', 'A_8429', 'A_8430', 'A_8431', 'A_8432', 'A_8433', 'A_8434', 'A_8435', 'A_8436', 'A_8437', 'A_8438', 'A_8439', 'A_8440', 'A_8441', 'A_8442', 'A_8443', 'A_8444', 'A_8445', 'A_8446', 'A_8447', 'A_8448', 'A_8449', 'A_8450', 'A_8451', 'A_8452', 'A_8453', 'A_8454', 'A_8455', 'A_8456', 'A_8457', 'A_8458', 'A_8459', 'A_8460', 'A_8461', 'A_8462', 'A_8463', 'A_8464', 'A_8465', 'A_8466', 'A_8467', 'A_8468', 'A_8469', 'A_8470', 'A_8471', 'A_8472', 'A_8473', 'A_8474', 'A_8475', 'A_8476', 'A_8477', 'A_8478', 'A_8479', 'A_8480', 'A_8481', 'A_8482', 'A_8483', 'A_8484', 'A_8485', 'A_8486', 'A_8487', 'A_8488', 'A_8489', 'A_8490', 'A_8491', 'A_8492', 'A_8493', 'A_8494', 'A_8495', 'A_8496', 'A_8497', 'A_8498', 'A_8499', 'A_8500', 'A_8501', 'A_8502', 'A_8503', 'A_8504', 'A_8505', 'A_8506', 'A_8507', 'A_8508', 'A_8509', 'A_8510', 'A_8511', 'A_8512', 'A_8513', 'A_8514', 'A_8515', 'A_8516', 'A_8517', 'A_8518', 'A_8519', 'A_8520', 'A_8521', 'A_8522', 'A_8523', 'A_8524', 'A_8525', 'A_8526', 'A_8527', 'A_8528', 'A_8529', 'A_8530', 'A_8531', 'A_8532', 'A_8533', 'A_8534', 'A_8535', 'A_8536', 'A_8537', 'A_8538', 'A_8539', 'A_8540', 'A_8541', 'A_8542', 'A_8543', 'A_8544', 'A_8545', 'A_8546', 'A_8547', 'A_8548', 'A_8549', 'A_8550', 'A_8551', 'A_8552', 'A_8553', 'A_8554', 'A_8555', 'A_8556', 'A_8557', 'A_8558', 'A_8559', 'A_8560', 'A_8561', 'A_8562', 'A_8563', 'A_8564', 'A_8565', 'A_8566', 'A_8567', 'A_8568', 'A_8569', 'A_8570', 'A_8571', 'A_8572', 'A_8573', 'A_8574', 'A_8575', 'A_8576', 'A_8577', 'A_8578', 'A_8579', 'A_8580', 'A_8581', 'A_8582', 'A_8583', 'A_8584', 'A_8585', 'A_8586', 'A_8587', 'A_8588', 'A_8589', 'A_8590', 'A_8591', 'A_8592', 'A_8593', 'A_8594', 'A_8595', 'A_8596', 'A_8597', 'A_8598', 'A_8599', 'A_8600', 'A_8601', 'A_8602', 'A_8603', 'A_8604', 'A_8605', 'A_8606', 'A_8607', 'A_8608', 'A_8609', 'A_8610', 'A_8611', 'A_8612', 'A_8613', 'A_8614', 'A_8615', 'A_8616', 'A_8617', 'A_8618', 'A_8619', 'A_8620', 'A_8621', 'A_8622', 'A_8623', 'A_8624', 'A_8625', 'A_8626', 'A_8627', 'A_8628', 'A_8629', 'A_8630', 'A_8631', 'A_8632', 'A_8633', 'A_8634', 'A_8635', 'A_8636', 'A_8637', 'A_8638', 'A_8639', 'A_8640', 'A_8641', 'A_8642', 'A_8643', 'A_8644', 'A_8645', 'A_8646', 'A_8647', 'A_8648', 'A_8649', 'A_8650', 'A_8651', 'A_8652', 'A_8653', 'A_8654', 'A_8655', 'A_8656', 'A_8657', 'A_8658', 'A_8659', 'A_8660', 'A_8661', 'A_8662', 'A_8663', 'A_8664', 'A_8665', 'A_8666', 'A_8667', 'A_8668', 'A_8669', 'A_8670', 'A_8671', 'A_8672', 'A_8673', 'A_8674', 'A_8675', 'A_8676', 'A_8677', 'A_8678', 'A_8679', 'A_8680', 'A_8681', 'A_8682', 'A_8683', 'A_8684', 'A_8685', 'A_8686', 'A_8687', 'A_8688', 'A_8689', 'A_8690', 'A_8691', 'A_8692', 'A_8693', 'A_8694', 'A_8695', 'A_8696', 'A_8697', 'A_8698', 'A_8699', 'A_8700', 'A_8701', 'A_8702', 'A_8703', 'A_8704', 'A_8705', 'A_8706', 'A_8707', 'A_8708', 'A_8709', 'A_8710', 'A_8711', 'A_8712', 'A_8713', 'A_8714', 'A_8715', 'A_8716', 'A_8717', 'A_8718', 'A_8719', 'A_8720', 'A_8721', 'A_8722', 'A_8723', 'A_8724', 'A_8725', 'A_8726', 'A_8727', 'A_8728', 'A_8729', 'A_8730', 'A_8731', 'A_8732', 'A_8733', 'A_8734', 'A_8735', 'A_8736', 'A_8737', 'A_8738', 'A_8739', 'A_8740', 'A_8741', 'A_8742', 'A_8743', 'A_8744', 'A_8745', 'A_8746', 'A_8747', 'A_8748', 'A_8749', 'A_8750', 'A_8751', 'A_8752', 'A_8753', 'A_8754', 'A_8755', 'A_8756', 'A_8757', 'A_8758', 'A_8759', 'A_8760', 'A_8761', 'A_8762', 'A_8763', 'A_8764', 'A_8765', 'A_8766', 'A_8767', 'A_8768', 'A_8769', 'A_8770', 'A_8771', 'A_8772', 'A_8773', 'A_8774', 'A_8775', 'A_8776', 'A_8777', 'A_8778', 'A_8779', 'A_8780', 'A_8781', 'A_8782', 'A_8783', 'A_8784', 'A_8785', 'A_8786', 'A_8787', 'A_8788', 'A_8789', 'A_8790', 'A_8791', 'A_8792', 'A_8793', 'A_8794', 'A_8795', 'A_8796', 'A_8797', 'A_8798', 'A_8799', 'A_8800', 'A_8801', 'A_8802', 'A_8803', 'A_8804', 'A_8805', 'A_8806', 'A_8807', 'A_8808', 'A_8809', 'A_8810', 'A_8811', 'A_8812', 'A_8813', 'A_8814', 'A_8815', 'A_8816', 'A_8817', 'A_8818', 'A_8819', 'A_8820', 'A_8821', 'A_8822', 'A_8823', 'A_8824', 'A_8825', 'A_8826', 'A_8827', 'A_8828', 'A_8829', 'A_8830', 'A_8831', 'A_8832', 'A_8833', 'A_8834', 'A_8835', 'A_8836', 'A_8837', 'A_8838', 'A_8839', 'A_8840', 'A_8841', 'A_8842', 'A_8843', 'A_8844', 'A_8845', 'A_8846', 'A_8847', 'A_8848', 'A_8849', 'A_8850', 'A_8851', 'A_8852', 'A_8853', 'A_8854', 'A_8855', 'A_8856', 'A_8857', 'A_8858', 'A_8859', 'A_8860', 'A_8861', 'A_8862', 'A_8863', 'A_8864', 'A_8865', 'A_8866', 'A_8867', 'A_8868', 'A_8869', 'A_8870', 'A_8871', 'A_8872', 'A_8873', 'A_8874', 'A_8875', 'A_8876', 'A_8877', 'A_8878', 'A_8879', 'A_8880', 'A_8881', 'A_8882', 'A_8883', 'A_8884', 'A_8885', 'A_8886', 'A_8887', 'A_8888', 'A_8889', 'A_8890', 'A_8891', 'A_8892', 'A_8893', 'A_8894', 'A_8895', 'A_8896', 'A_8897', 'A_8898', 'A_8899', 'A_8900', 'A_8901', 'A_8902', 'A_8903', 'A_8904', 'A_8905', 'A_8906', 'A_8907', 'A_8908', 'A_8909', 'A_8910', 'A_8911', 'A_8912', 'A_8913', 'A_8914', 'A_8915', 'A_8916', 'A_8917', 'A_8918', 'A_8919', 'A_8920', 'A_8921', 'A_8922', 'A_8923', 'A_8924', 'A_8925', 'A_8926', 'A_8927', 'A_8928', 'A_8929', 'A_8930', 'A_8931', 'A_8932', 'A_8933', 'A_8934', 'A_8935', 'A_8936', 'A_8937', 'A_8938', 'A_8939', 'A_8940', 'A_8941', 'A_8942', 'A_8943', 'A_8944', 'A_8945', 'A_8946', 'A_8947', 'A_8948', 'A_8949', 'A_8950', 'A_8951', 'A_8952', 'A_8953', 'A_8954', 'A_8955', 'A_8956', 'A_8957', 'A_8958', 'A_8959', 'A_8960', 'A_8961', 'A_8962', 'A_8963', 'A_8964', 'A_8965', 'A_8966', 'A_8967', 'A_8968', 'A_8969', 'A_8970', 'A_8971', 'A_8972', 'A_8973', 'A_8974', 'A_8975', 'A_8976', 'A_8977', 'A_8978', 'A_8979', 'A_8980', 'A_8981', 'A_8982', 'A_8983', 'A_8984', 'A_8985', 'A_8986', 'A_8987', 'A_8988', 'A_8989', 'A_8990', 'A_8991', 'A_8992', 'A_8993', 'A_8994', 'A_8995', 'A_8996', 'A_8997', 'A_8998', 'A_8999', 'A_9000', 'A_9001', 'A_9002', 'A_9003', 'A_9004', 'A_9005', 'A_9006', 'A_9007', 'A_9008', 'A_9009', 'A_9010', 'A_9011', 'A_9012', 'A_9013', 'A_9014', 'A_9015', 'A_9016', 'A_9017', 'A_9018', 'A_9019', 'A_9020', 'A_9021', 'A_9022', 'A_9023', 'A_9024', 'A_9025', 'A_9026', 'A_9027', 'A_9028', 'A_9029', 'A_9030', 'A_9031', 'A_9032', 'A_9033', 'A_9034', 'A_9035', 'A_9036', 'A_9037', 'A_9038', 'A_9039', 'A_9040', 'A_9041', 'A_9042', 'A_9043', 'A_9044', 'A_9045', 'A_9046', 'A_9047', 'A_9048', 'A_9049', 'A_9050', 'A_9051', 'A_9052', 'A_9053', 'A_9054', 'A_9055', 'A_9056', 'A_9057', 'A_9058', 'A_9059', 'A_9060', 'A_9061', 'A_9062', 'A_9063', 'A_9064', 'A_9065', 'A_9066', 'A_9067', 'A_9068', 'A_9069', 'A_9070', 'A_9071', 'A_9072', 'A_9073', 'A_9074', 'A_9075', 'A_9076', 'A_9077', 'A_9078', 'A_9079', 'A_9080', 'A_9081', 'A_9082', 'A_9083', 'A_9084', 'A_9085', 'A_9086', 'A_9087', 'A_9088', 'A_9089', 'A_9090', 'A_9091', 'A_9092', 'A_9093', 'A_9094', 'A_9095', 'A_9096', 'A_9097', 'A_9098', 'A_9099', 'A_9100', 'A_9101', 'A_9102', 'A_9103', 'A_9104', 'A_9105', 'A_9106', 'A_9107', 'A_9108', 'A_9109', 'A_9110', 'A_9111', 'A_9112', 'A_9113', 'A_9114', 'A_9115', 'A_9116', 'A_9117', 'A_9118', 'A_9119', 'A_9120', 'A_9121', 'A_9122', 'A_9123', 'A_9124', 'A_9125', 'A_9126', 'A_9127', 'A_9128', 'A_9129', 'A_9130', 'A_9131', 'A_9132', 'A_9133', 'A_9134', 'A_9135', 'A_9136', 'A_9137', 'A_9138', 'A_9139', 'A_9140', 'A_9141', 'A_9142', 'A_9143', 'A_9144', 'A_9145', 'A_9146', 'A_9147', 'A_9148', 'A_9149', 'A_9150', 'A_9151', 'A_9152', 'A_9153', 'A_9154', 'A_9155', 'A_9156', 'A_9157', 'A_9158', 'A_9159', 'A_9160', 'A_9161', 'A_9162', 'A_9163', 'A_9164', 'A_9165', 'A_9166', 'A_9167', 'A_9168', 'A_9169', 'A_9170', 'A_9171', 'A_9172', 'A_9173', 'A_9174', 'A_9175', 'A_9176', 'A_9177', 'A_9178', 'A_9179', 'A_9180', 'A_9181', 'A_9182', 'A_9183', 'A_9184', 'A_9185', 'A_9186', 'A_9187', 'A_9188', 'A_9189', 'A_9190', 'A_9191', 'A_9192', 'A_9193', 'A_9194', 'A_9195', 'A_9196', 'A_9197', 'A_9198', 'A_9199', 'A_9200', 'A_9201', 'A_9202', 'A_9203', 'A_9204', 'A_9205', 'A_9206', 'A_9207', 'A_9208', 'A_9209', 'A_9210', 'A_9211', 'A_9212', 'A_9213', 'A_9214', 'A_9215', 'A_9216', 'A_9217', 'A_9218', 'A_9219', 'A_9220', 'A_9221', 'A_9222', 'A_9223', 'A_9224', 'A_9225', 'A_9226', 'A_9227', 'A_9228', 'A_9229', 'A_9230', 'A_9231', 'A_9232', 'A_9233', 'A_9234', 'A_9235', 'A_9236', 'A_9237', 'A_9238', 'A_9239', 'A_9240', 'A_9241', 'A_9242', 'A_9243', 'A_9244', 'A_9245', 'A_9246', 'A_9247', 'A_9248', 'A_9249', 'A_9250', 'A_9251', 'A_9252', 'A_9253', 'A_9254', 'A_9255', 'A_9256', 'A_9257', 'A_9258', 'A_9259', 'A_9260', 'A_9261', 'A_9262', 'A_9263', 'A_9264', 'A_9265', 'A_9266', 'A_9267', 'A_9268', 'A_9269', 'A_9270', 'A_9271', 'A_9272', 'A_9273', 'A_9274', 'A_9275', 'A_9276', 'A_9277', 'A_9278', 'A_9279', 'A_9280', 'A_9281', 'A_9282', 'A_9283', 'A_9284', 'A_9285', 'A_9286', 'A_9287', 'A_9288', 'A_9289', 'A_9290', 'A_9291', 'A_9292', 'A_9293', 'A_9294', 'A_9295', 'A_9296', 'A_9297', 'A_9298', 'A_9299', 'A_9300', 'A_9301', 'A_9302', 'A_9303', 'A_9304', 'A_9305', 'A_9306', 'A_9307', 'A_9308', 'A_9309', 'A_9310', 'A_9311', 'A_9312', 'A_9313', 'A_9314', 'A_9315', 'A_9316', 'A_9317', 'A_9318', 'A_9319', 'A_9320', 'A_9321', 'A_9322', 'A_9323', 'A_9324', 'A_9325', 'A_9326', 'A_9327', 'A_9328', 'A_9329', 'A_9330', 'A_9331', 'A_9332', 'A_9333', 'A_9334', 'A_9335', 'A_9336', 'A_9337', 'A_9338', 'A_9339', 'A_9340', 'A_9341', 'A_9342', 'A_9343', 'A_9344', 'A_9345', 'A_9346', 'A_9347', 'A_9348', 'A_9349', 'A_9350', 'A_9351', 'A_9352', 'A_9353', 'A_9354', 'A_9355', 'A_9356', 'A_9357', 'A_9358', 'A_9359', 'A_9360', 'A_9361', 'A_9362', 'A_9363', 'A_9364', 'A_9365', 'A_9366', 'A_9367', 'A_9368', 'A_9369', 'A_9370', 'A_9371', 'A_9372', 'A_9373', 'A_9374', 'A_9375', 'A_9376', 'A_9377', 'A_9378', 'A_9379', 'A_9380', 'A_9381', 'A_9382', 'A_9383', 'A_9384', 'A_9385', 'A_9386', 'A_9387', 'A_9388', 'A_9389', 'A_9390', 'A_9391', 'A_9392', 'A_9393', 'A_9394', 'A_9395', 'A_9396', 'A_9397', 'A_9398', 'A_9399', 'A_9400', 'A_9401', 'A_9402', 'A_9403', 'A_9404', 'A_9405', 'A_9406', 'A_9407', 'A_9408', 'A_9409', 'A_9410', 'A_9411', 'A_9412', 'A_9413', 'A_9414', 'A_9415', 'A_9416', 'A_9417', 'A_9418', 'A_9419', 'A_9420', 'A_9421', 'A_9422', 'A_9423', 'A_9424', 'A_9425', 'A_9426', 'A_9427', 'A_9428', 'A_9429', 'A_9430', 'A_9431', 'A_9432', 'A_9433', 'A_9434', 'A_9435', 'A_9436', 'A_9437', 'A_9438', 'A_9439', 'A_9440', 'A_9441', 'A_9442', 'A_9443', 'A_9444', 'A_9445', 'A_9446', 'A_9447', 'A_9448', 'A_9449', 'A_9450', 'A_9451', 'A_9452', 'A_9453', 'A_9454', 'A_9455', 'A_9456', 'A_9457', 'A_9458', 'A_9459', 'A_9460', 'A_9461', 'A_9462', 'A_9463', 'A_9464', 'A_9465', 'A_9466', 'A_9467', 'A_9468', 'A_9469', 'A_9470', 'A_9471', 'A_9472', 'A_9473', 'A_9474', 'A_9475', 'A_9476', 'A_9477', 'A_9478', 'A_9479', 'A_9480', 'A_9481', 'A_9482', 'A_9483', 'A_9484', 'A_9485', 'A_9486', 'A_9487', 'A_9488', 'A_9489', 'A_9490', 'A_9491', 'A_9492', 'A_9493', 'A_9494', 'A_9495', 'A_9496', 'A_9497', 'A_9498', 'A_9499', 'A_9500', 'A_9501', 'A_9502', 'A_9503', 'A_9504', 'A_9505', 'A_9506', 'A_9507', 'A_9508', 'A_9509', 'A_9510', 'A_9511', 'A_9512', 'A_9513', 'A_9514', 'A_9515', 'A_9516', 'A_9517', 'A_9518', 'A_9519', 'A_9520', 'A_9521', 'A_9522', 'A_9523', 'A_9524', 'A_9525', 'A_9526', 'A_9527', 'A_9528', 'A_9529', 'A_9530', 'A_9531', 'A_9532', 'A_9533', 'A_9534', 'A_9535', 'A_9536', 'A_9537', 'A_9538', 'A_9539', 'A_9540', 'A_9541', 'A_9542', 'A_9543', 'A_9544', 'A_9545', 'A_9546', 'A_9547', 'A_9548', 'A_9549', 'A_9550', 'A_9551', 'A_9552', 'A_9553', 'A_9554', 'A_9555', 'A_9556', 'A_9557', 'A_9558', 'A_9559', 'A_9560', 'A_9561', 'A_9562', 'A_9563', 'A_9564', 'A_9565', 'A_9566', 'A_9567', 'A_9568', 'A_9569', 'A_9570', 'A_9571', 'A_9572', 'A_9573', 'A_9574', 'A_9575', 'A_9576', 'A_9577', 'A_9578', 'A_9579', 'A_9580', 'A_9581', 'A_9582', 'A_9583', 'A_9584', 'A_9585', 'A_9586', 'A_9587', 'A_9588', 'A_9589', 'A_9590', 'A_9591', 'A_9592', 'A_9593', 'A_9594', 'A_9595', 'A_9596', 'A_9597', 'A_9598', 'A_9599', 'A_9600', 'A_9601', 'A_9602', 'A_9603', 'A_9604', 'A_9605', 'A_9606', 'A_9607', 'A_9608', 'A_9609', 'A_9610', 'A_9611', 'A_9612', 'A_9613', 'A_9614', 'A_9615', 'A_9616', 'A_9617', 'A_9618', 'A_9619', 'A_9620', 'A_9621', 'A_9622', 'A_9623', 'A_9624', 'A_9625', 'A_9626', 'A_9627', 'A_9628', 'A_9629', 'A_9630', 'A_9631', 'A_9632', 'A_9633', 'A_9634', 'A_9635', 'A_9636', 'A_9637', 'A_9638', 'A_9639', 'A_9640', 'A_9641', 'A_9642', 'A_9643', 'A_9644', 'A_9645', 'A_9646', 'A_9647', 'A_9648', 'A_9649', 'A_9650', 'A_9651', 'A_9652', 'A_9653', 'A_9654', 'A_9655', 'A_9656', 'A_9657', 'A_9658', 'A_9659', 'A_9660', 'A_9661', 'A_9662', 'A_9663', 'A_9664', 'A_9665', 'A_9666', 'A_9667', 'A_9668', 'A_9669', 'A_9670', 'A_9671', 'A_9672', 'A_9673', 'A_9674', 'A_9675', 'A_9676', 'A_9677', 'A_9678', 'A_9679', 'A_9680', 'A_9681', 'A_9682', 'A_9683', 'A_9684', 'A_9685', 'A_9686', 'A_9687', 'A_9688', 'A_9689'}
        rule_out_set = {'A_8791_Study_4','A_9467_Study_4','A_8061_Study_3','A_9161_Study_2','A_9444_Study_3', 'A_9314_Study_2', 'A_9486_Study_1'}
                        
        patient_study = "A_" + image_file.split('_')[1] + "_Study_" + image_file.split('_')[3]
        # rule out studies containing less than 24 images
        if patient_study in rule_out_set:
            continue
        patient = "A_" + image_file.split('_')[1]
        if patient in complete_set:
            print(n)
            key = "_".join(image_file.split('_')[:-2])
            if key not in image_ids_map:
                image_ids_map[key] = []
            image_ids_map[key].append(reformat_image_id(image_file))
            n+=1

# Filter and select 26 images with the same second-to-last component for each study
for key, ids in image_ids_map.items():
    component_counts = {}
    for image_id in ids:
        component = image_id.split('_')[-2]
        if component not in component_counts:
            component_counts[component] = []
        component_counts[component].append(image_id)

    # Find the component with the most images and select the first 24 from it
    most_common_component = max(component_counts.keys(), key=lambda k: len(component_counts[k]))
    image_ids_map[key] = component_counts[most_common_component][:24]
        
# Create a mask to identify rows to exclude based on rule_out_set
exclude_mask = df.apply(lambda x: f"A_{x['Patient']}_Study_{x['Study']}" in rule_out_set, axis=1)

# Filter the dataframe to include only rows with patient numbers in the complete_set and exclude rows identified by exclude_mask
df = df[df['Patient'].apply(lambda x: f'A_{x}' in complete_set) & ~exclude_mask]

# Build the JSON structure
for index, row in tqdm(df.iterrows(), total=df.shape[0], desc="Building JSON"):
    key = f"A_{row['Patient']}_Study_{row['Study']}"
    image_ids = image_ids_map.get(key, [])
    
    ins_id = f"eval_INS_{str(index).zfill(5)}"
    data[ins_id] = {
        "instruction": instruction_text,
        "answer": row['Description'],
        "image_ids": image_ids,
        "rel_ins_ids": []
    }


# Build the final structure including meta
result = {
    "meta": {
        "version": "0.0.1",
        "time": "2023-08",
        "author": "big_data_center"
    },
    "data": data
}

# Save the resulting JSON
output_path = '/local2/chengyili/data/output/eval_instruction.json'
with open(output_path, 'w') as f:
    json.dump(result, f, indent=4)
